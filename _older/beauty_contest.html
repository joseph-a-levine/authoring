<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Keynesian Beauty‑Contest Game</title>
  <!-- external libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    body {font-family: system-ui, sans-serif; margin: 0; padding: 1rem; line-height: 1.4;}
    h1 {margin-top: 0;}
    section {margin-bottom: 2rem;}
    #chart-container {width: 100%; max-width: 700px; margin: auto;}
    canvas {max-width: 100%;}
    #qr {text-align: center;}
  </style>
</head>
<body>
  <h1>Keynesian Beauty‑Contest Game</h1>

  <section id="instructions">
    <p><strong>How to play</strong></p>
    <ol>
      <li>Scan the QR code below (same code works for both rounds).</li>
      <li>Form asks for <em>Name / Team</em>, <em>Round</em>, and <em>Guess</em>.</li>
      <li><strong>Round 1:</strong> type <em>your first name</em> in the Name / Team box.<br>
          <strong>Round 2:</strong> type <em>your team name</em>.</li>
      <li>Enter a whole number 0‑100. One submission per person (R1) or per team (R2).</li>
    </ol>
  </section>

  <section id="qr"></section>

  <!-- RESULTS ARE HIDDEN FROM PLAYERS.  Add ?admin=1 to URL to reveal. -->
  <section id="results" style="display:none;">
    <h2>Results (presenter view)</h2>
    <label for="roundSel">Round:</label>
    <select id="roundSel"><option value="1">1</option><option value="2">2</option></select>
    <button id="refreshBtn">Refresh</button>
    <p id="stats"></p>
    <div id="chart-container"><canvas id="hist"></canvas></div>
    <p id="winners"></p>
  </section>

<script>
// ===== CONFIGURATION (edit these two lines) =====
const FORM_URL = 'https://forms.gle/ibsdjNcdiGNWViLq8';

const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuFwz0UWcMfbKjI07xaJcCenPe4NAuPHbCvqys6cH7v_wJ18rXgylNd7I_w2q2u2wbFZqftdnbf56B/pub?output=csv';
// ===============================================

// Build QR code
new QRCode(document.getElementById('qr'), {text: FORM_URL, width: 180, height: 180});

// Parameter‑gated presenter mode
const params   = new URLSearchParams(window.location.search);
const isAdmin  = params.get('admin') === '1';
if (isAdmin) document.getElementById('results').style.display = 'block';

// ===== Chart helpers =====
let chart;
function makeChart(labels, counts) {
  const ctx = document.getElementById('hist');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {labels: labels, datasets: [{label: 'Frequency', data: counts}]},
    options: {scales: {y: {beginAtZero: true}}}
  });
}

// ===== Data utilities =====
async function loadCSV(url) {
  return new Promise((resolve) => {
    Papa.parse(url, {download: true, header: true, complete: res => resolve(res.data)});
  });
}

function analyse(rows, round) {
  rows = rows.filter(r => r.Round == round && r.Guess !== '');
  const guesses = rows.map(r => +r.Guess).filter(x => !isNaN(x) && x >= 0 && x <= 100);
  if (!guesses.length) return null;

  const avg = guesses.reduce((a, b) => a + b, 0) / guesses.length;
  const target = (2 / 3) * avg;

  const binLabels = Array.from({length: 10}, (_, i) => `${i * 10}‑${i * 10 + 9}`);
  const counts = Array(10).fill(0);
  guesses.forEach(g => counts[Math.min(9, Math.floor(g / 10))]++);

  const dist = guesses.map((g, i) => ({team: rows[i].Team, guess: g, gap: Math.abs(g - target)}));
  const minGap = Math.min(...dist.map(d => d.gap));
  const winners = dist.filter(d => d.gap === minGap);

  return {avg, target, binLabels, counts, winners};
}

async function refresh() {
  document.getElementById('stats').textContent = 'Loading…';
  const round = document.getElementById('roundSel').value;
  try {
    const rows = await loadCSV(SHEET_CSV_URL);
    const res = analyse(rows, round);
    if (!res) {document.getElementById('stats').textContent = 'No data yet.'; return;}
    makeChart(res.binLabels, res.counts);
    document.getElementById('stats').innerHTML = `N = ${res.counts.reduce((a,b)=>a+b,0)}<br>mean = ${res.avg.toFixed(2)}<br>2⁄3·mean = ${res.target.toFixed(2)}`;
    document.getElementById('winners').textContent = 'Closest team(s): ' + res.winners.map(w => `${w.team} (${w.guess})`).join(', ');
  } catch (err) {
    console.error(err);
    document.getElementById('stats').textContent = 'Error loading data.';
  }
}

// Hook up buttons & auto‑refresh only if admin
if (isAdmin) {
  document.getElementById('refreshBtn').addEventListener('click', refresh);
  refresh();
  setInterval(refresh, 15000);
}
</script>
</body>
</html>
